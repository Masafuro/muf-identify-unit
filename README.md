# muf-identify-unit

## 概要
muf-identify-unitは、MUF（Masafuro Unit Framework）アーキテクチャにおいて認証およびセッション管理を専門に担当するユニットです。本ユニットはユーザーの新規登録とログイン処理を行い、認証に成功したユーザーに対して一意のセッションIDを発行します。発行されたセッション情報はRedisに保持されるとともに、MUFネットワーク上のkeep空間を通じてシステム全体へ構造化データとして公開されます。

## システム構成
本ユニットはFastAPIによるWebインターフェースを提供し、永続データストレージとしてScyllaDB、セッション管理およびメッセージング基盤としてRedisを利用します。フロントエンドにはBootstrap 5を採用しており、PCやスマートフォンから利用可能なレスポンシブデザインに対応しています。

## 環境設定（.env）
動作には以下の環境変数の設定が必要です。各値はシステムのネットワーク構成に合わせて適切に設定してください。

| 変数名 | 説明 | デフォルト値 |
| :--- | :--- | :--- |
| REDIS_HOST | MUF基盤となるRedisのホスト名 | muf-redis |
| SCYLLA_HOST | ユーザー情報を保持するScyllaDBのホスト名 | muf-scylla |
| SCYLLA_KEYSPACE | ScyllaDB内で使用するキースペース名 | muf_auth |
| SESSION_TTL | セッションの有効期限（秒） | 3600 |
| LOGIN_REDIRECT_URL | ログイン成功後のリダイレクト先URL | / |

## MUFネットワーク仕様
ログイン成功時、本ユニットは以下のパスに対してセッション属性情報を公開します。

### 状態公開パス
muf/muf-identify-unit/keep/{session_id}

### 公開データ構造（JSON）
他のユニットはこのパスを参照することで、以下の情報を取得できます。
| フィールド名 | 型 | 説明 |
| :--- | :--- | :--- |
| username | string | ログインしたユーザーの名称 |
| user_id | string | ScyllaDB上の不変のユーザー識別子（UUID） |
| login_at | string | ISO8601形式のログイン日時 |

## ファイル構成
本ユニットは責務を分離するために以下のファイル構造をとっています。

- config.py: 環境変数と定数の管理
- database.py: ScyllaDBおよびRedisへの接続と初期化処理
- main.py: FastAPIによるルーティングとMUFメッセージングの実装
- templates/: ログインおよび新規登録用HTMLテンプレート
- __init__.py: パッケージ化のための初期化ファイル

## 導入と起動
MUF共通ネットワークが存在する環境で、docker-composeを実行することで起動します。起動プロセスにおいてScyllaDBの準備が完了するまで自動的にリトライ接続を行うため、データベースの起動完了を待たずにユニットを立ち上げることが可能です。